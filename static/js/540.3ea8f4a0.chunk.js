"use strict";(self.webpackChunkclient=self.webpackChunkclient||[]).push([[540],{9540:function(n,t,e){e.r(t),e.d(t,{default:function(){return H}});var r=e(2723),a=e(4795),i=e(8777),u=e(969),c=e(7563),o=e(3028),s=e(8068),l=e(3649),d=e(1576),f=e(9008),v=e(804),h=(0,s.hg)("canvas/list",function(){var n=(0,a.Z)((0,r.Z)().mark((function n(t,e){var a,i;return(0,r.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a=e.dispatch,n.next=3,(0,d.U2)("/drawing");case 3:return 200===(i=n.sent).status&&a(v.Nw.patch({items:i.data.items,loaded:!0})),n.abrupt("return",i.data);case 6:case"end":return n.stop()}}),n)})));return function(t,e){return n.apply(this,arguments)}}()),p=(0,s.hg)("canvas/get",function(){var n=(0,a.Z)((0,r.Z)().mark((function n(t,e){var a,i,u,c,o,s,h,p,x;return(0,r.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(i=e.dispatch,u=e.getState,o=u(),s=null===(a=o.app.user)||void 0===a?void 0:a.userId,c=o.canvas.items.find((function(n){return n.id===t}))){n.next=12;break}return n.next=7,(0,d.U2)("/drawing/".concat(t));case 7:404===(h=n.sent).status&&i((0,l.cB)("Drawing ".concat(t," not found"))),p=h.data||(0,f.eJ)(),x=p.userId===s,c=x?p:(0,f.sn)(p);case 12:return i(v.Nw.patchActive(c)),n.abrupt("return",c);case 14:case"end":return n.stop()}}),n)})));return function(t,e){return n.apply(this,arguments)}}()),x=(0,s.hg)("canvas/save",function(){var n=(0,a.Z)((0,r.Z)().mark((function n(t,e){var a,i,u,c,s,f,h;return(0,r.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a=t.history,i=t.thumbnail,u=e.dispatch,c=e.getState,s=c(),f=(0,o.Z)((0,o.Z)({},s.canvas.active),{},{history:a,thumbnail:i}),["draft","copy"].includes(f.id)&&(f.id=void 0),n.next=7,(0,d.WY)("/drawing",f);case 7:return 200===(h=n.sent).status&&(u(v.Nw.onSave(h.data)),u((0,l.h4)("Saved, scroll down to see"))),n.abrupt("return",h.data);case 10:case"end":return n.stop()}}),n)})));return function(t,e){return n.apply(this,arguments)}}()),g=(0,s.hg)("canvas/delete",function(){var n=(0,a.Z)((0,r.Z)().mark((function n(t,e){var a,i,u,c,o;return(0,r.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a=e.dispatch,i=e.getState,n.next=3,(0,d.WY)("/drawing/".concat(t),null,d.n$.DELETE);case 3:if(200===n.sent.status){n.next=6;break}return n.abrupt("return");case 6:u=i().canvas.items,c=u.filter((function(n){return n.id!==t})),o=c.find((function(n){return n.id===t}))||(0,f.eJ)(),a(v.Nw.patch({items:c,active:o}));case 10:case"end":return n.stop()}}),n)})));return function(t,e){return n.apply(this,arguments)}}()),Z=e(2563),w=e(5260),m=e(7771),b=e(4325),k=e(325),C=e(7574);function j(){var n=(0,c.CG)((function(n){return n.canvas.loading}));return(0,C.jsx)(C.Fragment,{children:(0,C.jsx)(k.Z,{className:"".concat(n?"":"invisible"),sx:{position:"absolute",left:"50%",top:"50%"}})})}var y=e(2207),R=e(4780),S=e(5433),U=e(7406),T=e(1874),E=e(4417),N=e(6385),G=e(734),L=e(7024),z=e(1925);function D(n){var t=(0,c.CG)((function(n){return n.canvas.items})),e=(0,c.CG)((function(n){return n.canvas.loaded})),i=(0,c.CG)((function(n){var t;return null===(t=n.canvas.active)||void 0===t?void 0:t.id})),s=(0,c.TL)(),l=(0,G.s0)(),d=(0,u.useCallback)((function(n){return s(v.Nw.patchActive(n))}),[s]),f=function(n){return i===(null===n||void 0===n?void 0:n.id)},p=(0,G.UO)().id,x=function(){var n=(0,a.Z)((0,r.Z)().mark((function n(t){return(0,r.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,s(g(t.id));case 2:"fulfilled"===n.sent.meta.requestStatus&&p===t.id&&l(L.nB.Draw,{replace:!0});case 4:case"end":return n.stop()}}),n)})));return function(t){return n.apply(this,arguments)}}();return u.useEffect((function(){e||s(h())}),[s,e]),t.length?(0,C.jsx)(Z.Z,(0,o.Z)((0,o.Z)({maxWidth:"xl"},n),{},{children:(0,C.jsx)(R.Z,{variant:"elevation",sx:{padding:"1rem"},children:(0,C.jsx)(S.Z,{children:t.map((function(n){return(0,C.jsxs)(U.Z,{sx:{border:"solid 1px ".concat(f(n)?"#ab47bc":"transparent"),borderWidth:"0 0 1px 0",transition:"all 200ms ease-in"},children:[(0,C.jsx)("img",{src:n.thumbnail,alt:n.name,loading:"lazy",style:{backgroundColor:"rgba(200, 163, 255, .1)",height:z.Z.thumbnails.height,width:z.Z.thumbnails.width},width:z.Z.thumbnails.width,height:z.Z.thumbnails.height}),(0,C.jsx)(T.Z,{title:n.name,actionIcon:(0,C.jsxs)(C.Fragment,{children:[(0,C.jsx)(E.Z,{onClick:function(){return d(n)},children:"Edit"}),(0,C.jsx)(N.Z,{onClick:function(){return x(n)},children:(0,C.jsx)(y.Z,{})})]})})]},n.id)}))})})})):null}var M=e(8658);function W(n){var t=n.canvasRef,e=n.contextRef,r=n.record,a=(0,c.CG)((function(n){return n.canvas.color})),i=(0,c.CG)((function(n){return n.canvas.size})),o=u.useRef(!1),s=u.useCallback((function(n,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];null!==e&&void 0!==e&&e.current&&(e.current.lineTo(n,t),e.current.stroke(),a||r(M.Us.Stroke,n,t))}),[e,r]),l=function(n,u){e.current&&t.current&&(e.current.beginPath(),e.current.lineTo(n+1,u+1),e.current.stroke(),"transparent"===a?e.current.globalCompositeOperation="destination-out":(e.current.globalCompositeOperation="source-over",e.current.strokeStyle=a||z.Z.defaultColor),e.current.lineWidth=i||z.Z.defaultLineSize,o.current=!0,t.current.style.cursor="crosshair",r(M.Us.Open,n+1,u+1))},d=function(){e.current&&t.current&&(e.current.closePath(),o.current=!1,t.current.style.cursor="default",r(M.Us.Close),e.current)};return u.useEffect((function(){var n=t.current,r=null===n||void 0===n?void 0:n.getContext("2d");if(n&&r){e.current=r,(0,f.oT)(n),(0,f.ZU)(r);var a=function(){(0,f.oT)(n,!0)};return window.addEventListener("resize",a),function(){return window.removeEventListener("resize",(function(){return a}))}}}),[t,e]),(0,C.jsx)("canvas",{style:{flex:1,touchAction:"pinch-zoom"},onTouchStart:function(n){var t;if(!((null===(t=n.touches)||void 0===t?void 0:t.length)>1)){var e=n.touches[0].clientX,r=n.touches[0].clientY;l(e,r)}},onTouchMove:function(n){var t;if(!((null===(t=n.touches)||void 0===t?void 0:t.length)>1)){var e=n.touches[0].clientX,r=n.touches[0].clientY;s(e,r)}},onTouchEnd:d,onMouseDown:function(n){var t=n.nativeEvent,e=t.offsetX,r=t.offsetY;l(e,r)},onMouseUp:d,onMouseMove:function(n){var t=n.nativeEvent;if(o.current&&null!==e&&void 0!==e&&e.current){var r=t.offsetX,a=t.offsetY;s(r,a)}},ref:t})}var O=e(2867),P=e(9956),Y=e(4954),A=["yellow","red","blue","green","black"];function B(n){var t=(0,c.TL)(),e=(0,c.CG)((function(n){return n.canvas.color})),r=u.useState(),a=(0,O.Z)(r,2),i=a[0],s=a[1],l=function(n){return e===n},d=function(n){var r="transparent"===n&&"transparent"===e?i:n;t(v.Nw.patch({color:r})),s(e)};return(0,C.jsx)(w.Z,(0,o.Z)((0,o.Z)({},n),{},{children:(0,C.jsxs)(m.Z,{spacing:1,children:[A.map((function(n){return(0,C.jsx)(b.Z,{sx:{backgroundColor:n},onClick:function(){return d(n)},children:l(n)&&(0,C.jsx)(P.Z,{})},n)})),(0,C.jsx)(b.Z,{title:"eraser",onClick:function(){return d("transparent")},children:(0,C.jsx)(Y.Z,{sx:{transform:l("transparent")?"rotate(-45deg)":"rotate(-90deg)",transition:"all 200ms ease-in"}})})]})}))}var F=e(2221),I=e(9798),X=(0,F.ZP)(I.Z)({position:"absolute",top:"10%",left:"20%"});function J(n){var t=n.inputRef,e=n.save,r=(0,c.CG)((function(n){var t;return null===(t=n.canvas)||void 0===t?void 0:t.active})),a=(0,c.TL)(),i=u.useCallback((function(n){a(v.Nw.patchActive({name:n.target.value}))}),[a]);return(0,C.jsx)(X,{variant:"standard",autoFocus:"draft"===r.id,accessKey:"N",inputRef:t,value:(null===r||void 0===r?void 0:r.name)||"",onChange:i,onKeyUp:function(n){"Enter"===n.key&&e()}},"".concat(r.id,"-").concat(r.createdAt))}var K=e(3069),$=(0,F.ZP)(Z.Z)({position:"absolute",bottom:"3%",left:"20%",width:"70%"});function q(){var n=(0,c.CG)((function(n){return n.canvas.size})),t=(0,c.TL)();return(0,C.jsx)($,{children:(0,C.jsx)(K.ZP,{value:n||z.Z.defaultLineSize,onChange:function(n,e){return t(v.Nw.patch({size:e}))},min:1,max:100,valueLabelDisplay:"auto",title:"Line size"})})}function V(){var n=(0,c.TL)(),t=(0,c.CG)((function(n){return n.app.token})),o=(0,c.CG)((function(n){var t,e;return null===(t=n.canvas)||void 0===t||null===(e=t.active)||void 0===e?void 0:e.history})),s=(0,c.CG)((function(n){var t,e;return null===(t=n.canvas)||void 0===t||null===(e=t.active)||void 0===e?void 0:e.id})),d=(0,u.useRef)(null),h=(0,u.useRef)(null),g=(0,u.useRef)([]),k=(0,u.useRef)(null),y=(0,u.useRef)(null),R=(0,u.useRef)(null),S=(0,G.UO)().id,U=(0,G.s0)(),T=u.useCallback((function(n,t,e){var r,a,u=null===(r=h.current)||void 0===r?void 0:r.lineWidth,c=null===(a=h.current)||void 0===a?void 0:a.strokeStyle,o=(new Date).getTime();g.current=[].concat((0,i.Z)(g.current),[{x:t,y:e,t:n,w:u,c:c,ts:o}])}),[]),E=u.useCallback((function(){var n=d.current,t=null===n||void 0===n?void 0:n.getContext("2d");n&&t&&(t.clearRect(0,0,n.width,n.height),g.current=[],k.current=null,U("".concat(L.nB.Draw),{replace:!0}))}),[U]),N=u.useCallback((function(){E();var t=(0,f.eJ)();n(v.Nw.patch({active:t}))}),[E,n]),z=u.useCallback((0,a.Z)((0,r.Z)().mark((function e(){var a,i,u;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=d.current,i=null===a||void 0===a?void 0:a.getContext("2d"),a&&i){e.next=4;break}return e.abrupt("return");case 4:if(t){e.next=7;break}return n((0,l.r$)({dialog:"onboard"})),e.abrupt("return");case 7:return e.t0=g.current,e.next=10,(0,f.eV)(a);case 10:return e.t1=e.sent,u={history:e.t0,thumbnail:e.t1},e.next=14,n(x(u));case 14:case"end":return e.stop()}}),e)}))),[t,n]),M=u.useCallback((function(){if(d.current&&h.current){if(!R.current){var t=new Worker(new URL(e.p+e.u(997),e.b));t.onmessage=function(t){var e;h.current||console.error("no context for result"),null===(e=h.current)||void 0===e||e.putImageData(t.data,0,0),n(v.Nw.patch({loading:!1}))},R.current=t}n(v.Nw.patch({loading:!0}));var r=d.current.getBoundingClientRect(),a=r.width,i=r.height;R.current.postMessage({buffer:g.current,width:a,height:i,dpr:window.devicePixelRatio})}}),[n]);return u.useEffect((function(){if("draft"!==s){if(k.current!==s){var n="draft"===k.current&&!!s&&"draft"!==s;k.current=s,n||(g.current=o,(0,u.startTransition)((function(){M()})))}}else E()}),[s,o,M,E]),u.useEffect((function(){function t(){return(t=(0,a.Z)((0,r.Z)().mark((function t(){var e,a;return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!S||s===S){t.next=5;break}return t.next=3,n(p(S));case 3:"copy"===(null===(a=t.sent)||void 0===a||null===(e=a.payload)||void 0===e?void 0:e.id)&&U("".concat(L.nB.Draw),{replace:!0});case 5:case"end":return t.stop()}}),t)})))).apply(this,arguments)}!function(){t.apply(this,arguments)}()}),[n,s,U,S]),(0,C.jsxs)(Z.Z,{maxWidth:!1,disableGutters:!0,sx:{display:"flex",flexFlow:"column"},children:[(0,C.jsx)(W,{canvasRef:d,contextRef:h,record:T}),(0,C.jsx)(J,{inputRef:y,save:z}),(0,C.jsxs)(w.Z,{sx:{position:"absolute",top:"30%",right:"3%"},children:[(0,C.jsx)(B,{}),(0,C.jsxs)(m.Z,{spacing:1,mt:"1rem",children:[(0,C.jsx)(b.Z,{color:"secondary",onClick:N,children:"New"}),(0,C.jsx)(b.Z,{color:"secondary",onClick:E,children:"Clear"}),(0,C.jsx)(b.Z,{color:"secondary",onClick:z,children:"Save"})]})]}),(0,C.jsx)(q,{}),(0,C.jsx)(j,{}),(0,C.jsx)(D,{sx:{mb:"1rem"}})]})}function H(){return(0,C.jsx)("div",{children:(0,C.jsx)(V,{})})}},8658:function(n,t,e){e.d(t,{Us:function(){return r.Us},g9:function(){return r.g9}});var r=e(7413)},7926:function(n,t,e){var r;function a(n){var t=Math.round(function(n){if(n.history.length<2)return 0;var t=n.history[0].ts;return n.history[n.history.length-1].ts-t}(n)/1e3),e=Math.round(t/60),r=Math.round(e/60),a=t%60;return"".concat(r,"h:").concat(e,"m:").concat(a,"s")}e.d(t,{Us:function(){return r},g9:function(){return a}}),function(n){n[n.Open=0]="Open",n[n.Close=1]="Close",n[n.Stroke=2]="Stroke"}(r||(r={}))},7413:function(n,t,e){e.d(t,{Us:function(){return r.Us},g9:function(){return r.g9}});var r=e(7926)}}]);
//# sourceMappingURL=540.3ea8f4a0.chunk.js.map